<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åŠ¨æ€å¤©æ°”</title>
<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow-x: hidden;
        font-family: "Segoe UI", sans-serif;
        color: #333;
    }
    body {
        position: relative;
    }
    canvas {
        position: fixed;
        top: 0;
        left: 0;
        z-index: -1;
    }
    .container {
        max-width: 900px;
        margin: auto;
        padding: 20px;
    }
    .card {
        background: rgba(255, 255, 255, 0.85);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .title {
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 10px;
    }
    .weather-main {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .weather-temp {
        font-size: 2.5em;
        font-weight: bold;
    }
    .forecast {
        display: flex;
        overflow-x: auto;
        gap: 10px;
    }
    .forecast-item {
        flex: 0 0 auto;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        padding: 10px;
        text-align: center;
        width: 100px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
</style>
</head>
<body>
<canvas id="weatherCanvas"></canvas>

<div class="container">
    <div class="card" id="location-card">
        <div class="title">å½“å‰ä½ç½®</div>
        <div id="location">æ­£åœ¨è·å–å®šä½...</div>
        <div style="margin-top: 15px;">
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="city-input" placeholder="è¯·è¾“å…¥åŸå¸‚åç§°" style="padding: 8px; flex: 1; border: 1px solid #ddd; border-radius: 5px;">
                <button id="search-city" style="padding: 8px 15px; background: #4facfe; color: white; border: none; border-radius: 5px;">æŸ¥è¯¢</button>
            </div>
            <p id="city-error" style="color: red; margin-top: 5px; font-size: 14px; display: none;"></p>
        </div>
    </div>

    <div class="card">
        <div class="title">å®æ—¶å¤©æ°”</div>
        <div class="weather-main">
            <div>
                <div id="temp" class="weather-temp">--Â°C</div>
                <div id="desc">--</div>
            </div>
            <div id="icon" style="font-size:48px;">â˜€ï¸</div>
        </div>
    </div>

    <div class="card">
        <div class="title">æœªæ¥48å°æ—¶</div>
        <div class="forecast" id="hourly"></div>
    </div>

    <div class="card">
        <div class="title">æœªæ¥3å¤©</div>
        <div class="forecast" id="daily"></div>
    </div>
</div>

<script>
const API_KEY = "0nRahTS8MYHrujeP";
// é«˜å¾·åœ°å›¾åœ°ç†ç¼–ç APIå¯†é’¥
const GAODE_API_KEY = "bd5388dfef81ab0f12b81ff9d179b61b";

// èƒŒæ™¯åŠ¨ç”»
let canvas = document.getElementById("weatherCanvas");
let ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let particles = [];

function setBackgroundEffect(skycon) {
    particles = [];
    if (skycon.includes("RAIN")) createRain();
    else if (skycon.includes("SNOW")) createSnow();
    else particles = []; // æ™´å¤©æ— ç‰¹æ•ˆ
}

function createRain() {
    for (let i = 0; i < 150; i++) {
        particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            len: Math.random() * 20 + 10,
            speed: Math.random() * 4 + 4
        });
    }
}

function createSnow() {
    for (let i = 0; i < 100; i++) {
        particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            r: Math.random() * 4 + 1,
            speed: Math.random() * 1 + 0.5
        });
    }
}

function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "rgba(255,255,255,0.8)";
    particles.forEach(p => {
        if (p.len) { // rain
            ctx.beginPath();
            ctx.strokeStyle = "rgba(174,194,224,0.8)";
            ctx.moveTo(p.x, p.y);
            ctx.lineTo(p.x, p.y + p.len);
            ctx.stroke();
            p.y += p.speed;
            if (p.y > canvas.height) p.y = -p.len;
        } else { // snow
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fill();
            p.y += p.speed;
            if (p.y > canvas.height) p.y = -p.r;
        }
    });
    requestAnimationFrame(animate);
}
animate();

function setBackgroundColor(skycon) {
    const weatherMap = {
        "CLEAR_DAY": "linear-gradient(to bottom, #4facfe, #00f2fe)",
        "CLEAR_NIGHT": "linear-gradient(to bottom, #141E30, #243B55)",
        "PARTLY_CLOUDY_DAY": "linear-gradient(to bottom, #d7d2cc, #304352)",
        "PARTLY_CLOUDY_NIGHT": "linear-gradient(to bottom, #232526, #414345)",
        "CLOUDY": "linear-gradient(to bottom, #757f9a, #d7dde8)",
        "RAIN": "linear-gradient(to bottom, #00c6fb, #005bea)",
        "SNOW": "linear-gradient(to bottom, #e0eafc, #cfdef3)"
    };
    document.body.style.background = weatherMap[skycon] || "linear-gradient(to bottom, #a0cfff, #ffffff)";
}

function fetchWeather(lat, lon) {
    const url = `https://api.caiyunapp.com/v2.6/${API_KEY}/${lon},${lat}/weather.jsonp?callback=MYCALLBACK`;
    const script = document.createElement('script');
    script.src = url;
    document.body.appendChild(script);
}

function MYCALLBACK(data) {
    if (!data || !data.result) return;
    const realtime = data.result.realtime;
    const hourly = data.result.hourly;
    const daily = data.result.daily;

    document.getElementById("temp").textContent = `${realtime.temperature}Â°C`;
    document.getElementById("desc").textContent = realtime.skycon;
    document.getElementById("icon").textContent = skyconEmoji(realtime.skycon);

    setBackgroundColor(realtime.skycon);
    setBackgroundEffect(realtime.skycon);

    // æœªæ¥48å°æ—¶
    const hourlyDiv = document.getElementById("hourly");
    hourly.temperature.forEach((t, i) => {
        const time = new Date(hourly.temperature[i].datetime).getHours();
        const div = document.createElement("div");
        div.className = "forecast-item";
        div.innerHTML = `<div>${time}æ—¶</div><div>${t.value}Â°C</div>`;
        hourlyDiv.appendChild(div);
    });

    // æœªæ¥3å¤©
    const dailyDiv = document.getElementById("daily");
    daily.temperature.forEach((t, i) => {
        const date = new Date(daily.temperature[i].date).toLocaleDateString();
        const div = document.createElement("div");
        div.className = "forecast-item";
        div.innerHTML = `<div>${date}</div><div>${t.max} / ${t.min}Â°C</div>`;
        dailyDiv.appendChild(div);
    });
}

function skyconEmoji(skycon) {
    const map = {
        "CLEAR_DAY": "â˜€ï¸",
        "CLEAR_NIGHT": "ğŸŒ™",
        "PARTLY_CLOUDY_DAY": "â›…",
        "PARTLY_CLOUDY_NIGHT": "â˜ï¸",
        "CLOUDY": "â˜ï¸",
        "RAIN": "ğŸŒ§ï¸",
        "SNOW": "â„ï¸"
    };
    return map[skycon] || "â˜€ï¸";
}

// æ ¹æ®åŸå¸‚åç§°è·å–ç»çº¬åº¦
function getLocationByCity(cityName) {
    if (!cityName || cityName.trim() === '') {
        document.getElementById("city-error").textContent = "è¯·è¾“å…¥æœ‰æ•ˆçš„åŸå¸‚åç§°";
        document.getElementById("city-error").style.display = "block";
        return;
    }

    document.getElementById("city-error").style.display = "none";
    document.getElementById("location").textContent = `æ­£åœ¨è·å–${cityName}çš„ä½ç½®ä¿¡æ¯...`;

    const url = `https://restapi.amap.com/v3/geocode/geo?key=${GAODE_API_KEY}&address=${encodeURIComponent(cityName)}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.status === '1' && data.geocodes.length > 0) {
                const location = data.geocodes[0].location;
                const [lon, lat] = location.split(',');
                document.getElementById("location").textContent = `åŸå¸‚: ${cityName}, çº¬åº¦: ${lat}, ç»åº¦: ${lon}`;
                fetchWeather(lat, lon);
            } else {
                document.getElementById("city-error").textContent = `æœªæ‰¾åˆ°${cityName}çš„ä½ç½®ä¿¡æ¯ï¼Œè¯·å°è¯•å…¶ä»–åŸå¸‚`;
                document.getElementById("city-error").style.display = "block";
                document.getElementById("location").textContent = "å®šä½å¤±è´¥";
            }
        })
        .catch(error => {
            console.error('åœ°ç†ç¼–ç APIè¯·æ±‚å¤±è´¥:', error);
            document.getElementById("city-error").textContent = "è·å–ä½ç½®ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•";
            document.getElementById("city-error").style.display = "block";
            document.getElementById("location").textContent = "å®šä½å¤±è´¥";
        });
}

// åˆå§‹åŒ–åŸå¸‚æŸ¥è¯¢æŒ‰é’®äº‹ä»¶
document.getElementById("search-city").addEventListener('click', () => {
    const cityName = document.getElementById("city-input").value;
    getLocationByCity(cityName);
});

// æŒ‰ä¸‹å›è½¦é”®æŸ¥è¯¢åŸå¸‚
document.getElementById("city-input").addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        const cityName = document.getElementById("city-input").value;
        getLocationByCity(cityName);
    }
});

// è·å–ä½ç½®
function getUserLocation() {
    if (!navigator.geolocation) {
        document.getElementById("location").textContent = "æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®æœåŠ¡ï¼Œè¯·è¾“å…¥åŸå¸‚åç§°æŸ¥è¯¢";
        return;
    }

    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude.toFixed(4);
            const lon = pos.coords.longitude.toFixed(4);
            document.getElementById("location").textContent = `å½“å‰ä½ç½®: çº¬åº¦: ${lat}, ç»åº¦: ${lon}`;
            fetchWeather(lat, lon);
        },
        err => {
            let errorMsg = "å®šä½å¤±è´¥ï¼Œè¯·è¾“å…¥åŸå¸‚åç§°æŸ¥è¯¢";
            switch(err.code) {
                case err.PERMISSION_DENIED:
                    errorMsg = "æ‚¨æ‹’ç»äº†å®šä½è¯·æ±‚ï¼Œè¯·å…è®¸ä½ç½®æƒé™æˆ–è¾“å…¥åŸå¸‚åç§°æŸ¥è¯¢";
                    break;
                case err.POSITION_UNAVAILABLE:
                    errorMsg = "ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥è®¾å¤‡å®šä½æœåŠ¡æˆ–è¾“å…¥åŸå¸‚åç§°æŸ¥è¯¢";
                    break;
                case err.TIMEOUT:
                    errorMsg = "å®šä½è¶…æ—¶ï¼Œè¯·é‡è¯•æˆ–è¾“å…¥åŸå¸‚åç§°æŸ¥è¯¢";
                    break;
                case err.UNKNOWN_ERROR:
                    errorMsg = "æœªçŸ¥é”™è¯¯å¯¼è‡´å®šä½å¤±è´¥ï¼Œè¯·è¾“å…¥åŸå¸‚åç§°æŸ¥è¯¢";
                    break;
            }
            document.getElementById("location").textContent = errorMsg;
            // åˆ é™¤æ—§çš„ç»çº¬åº¦è¾“å…¥æ¡†
            const oldInputContainer = document.getElementById("location-input-container");
            if (oldInputContainer) {
                oldInputContainer.remove();
            }
        },
        {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        }
    );
}

// åˆå§‹åŒ–è°ƒç”¨
getUserLocation();
</script>
</body>
</html>
