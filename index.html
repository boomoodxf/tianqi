<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>高级天气展示卡片 — 原生 HTML/CSS/JS</title>
<style>
  :root{
    --bg:#0b0f14;
    --card-bg: rgba(255,255,255,0.04);
    --card-border: rgba(255,255,255,0.06);
    --glass-blur: 12px;
    --accent: #7dd3fc;
    --text-main: #e6eef6;
    --muted: #9aa6b3;
    --transition: 400ms cubic-bezier(.2,.9,.3,1);
    --safe-padding: clamp(12px, 3vw, 32px);
  }

  /* Weather theme variables: updated per-mode via JS by toggling .mode-xxx on body */
  body.mode-sunny { --accent: #FFD166; --card-bg: rgba(255,255,255,0.03); --bg: linear-gradient(180deg,#071028 0%, #09203a 60%); }
  body.mode-rainy { --accent: #80b3ff; --card-bg: rgba(5,10,18,0.6); --bg: linear-gradient(180deg,#041221 0%, #07151b 60%); }
  body.mode-snowy { --accent: #cfe9ff; --card-bg: rgba(6,10,14,0.55); --bg: linear-gradient(180deg,#04131c 0%, #062033 60%); }
  body.mode-windy { --accent: #9be7c4; --card-bg: rgba(6,10,14,0.55); --card-border: rgba(255,255,255,0.04); --bg: linear-gradient(180deg,#04181a 0%, #06282a 60%); }

  /* Fullscreen base */
  html,body{
    height:100%;
    margin:0;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: var(--bg);
    color:var(--text-main);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    transition: background var(--transition);
    -webkit-tap-highlight-color: transparent;
  }

  /* layer for full-screen effects */
  .weather-stage{
    position:fixed;
    inset:0;
    pointer-events:none;
    z-index:0;
    overflow:hidden;
  }
  /* Canvas layers will be inside .weather-stage; they will fade in/out */
  .layer{
    position:absolute;
    inset:0;
    opacity:0;
    transition: opacity var(--transition);
    will-change: opacity;
  }
  .layer.visible{ opacity:1; pointer-events:auto; }

  /* main wrapper to center card */
  .wrap{
    min-height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:calc(var(--safe-padding)*1.2);
    box-sizing:border-box;
    z-index:1;
    position:relative;
  }

  /* The fancy card */
  .card{
    width:min(760px, 94vw);
    max-width:900px;
    border-radius:20px;
    padding:24px;
    box-sizing:border-box;
    backdrop-filter: blur(var(--glass-blur)) saturate(120%);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));
    border: 1px solid var(--card-border);
    box-shadow: 0 8px 30px rgba(2,6,12,0.6);
    display:grid;
    grid-template-columns: 1fr 320px;
    gap:20px;
    align-items:center;
    transition: transform 450ms cubic-bezier(.2,.9,.3,1), background var(--transition), box-shadow var(--transition);
  }

  /* mobile: stack */
  @media (max-width:740px){
    .card{ grid-template-columns: 1fr; padding:18px; gap:12px; border-radius:16px; }
  }

  /* Left: info */
  .card-main{
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .city{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .city h1{
    margin:0;
    font-size:clamp(18px,3.2vw,26px);
    letter-spacing:0.2px;
  }
  .muted{ color:var(--muted); font-size:13px; }

  .temp-row{
    display:flex;
    align-items:flex-start;
    gap:18px;
  }
  .temp{
    font-weight:700;
    font-size:clamp(48px,9vw,72px);
    line-height:0.95;
    margin:0;
    color:var(--text-main);
  }
  .desc{
    margin-top:6px;
    color:var(--muted);
    font-size:16px;
  }

  /* Right: small panel with controls & extras */
  .card-side{
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:14px;
    align-items:stretch;
  }
  .controls{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }

  /* buttons */
  .btn{
    appearance:none;
    border:1px solid rgba(255,255,255,0.06);
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    color:var(--text-main);
    padding:10px 12px;
    border-radius:10px;
    cursor:pointer;
    display:inline-flex;
    gap:8px;
    align-items:center;
    justify-content:center;
    font-weight:600;
    font-size:13px;
    transition: transform 160ms ease, box-shadow 160ms ease, background var(--transition);
    box-shadow: 0 2px 6px rgba(2,6,12,0.5);
  }
  .btn:hover{ transform: translateY(-4px); box-shadow: 0 8px 28px rgba(2,6,12,0.6); }
  .btn:active{ transform: translateY(-1px) scale(.995); }
  .btn[aria-pressed="true"]{
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    border-color: rgba(255,255,255,0.12);
    box-shadow: 0 12px 30px rgba(0,0,0,0.6), 0 0 0 4px rgba(0,0,0,0.02) inset;
  }

  /* tiny legend */
  .meta{ color:var(--muted); font-size:13px; }

  /* Icon small */
  .ico{
    width:18px;height:18px;flex:0 0 18px;
    display:inline-block;
  }

  /* subtle indicator line under card */
  .card::after{
    content:'';
    position:absolute;
    left:18px;
    right:18px;
    bottom:10px;
    height:1px;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
    border-radius:2px;
    pointer-events:none;
  }

  /* Footer small text */
  .foot{
    margin-top:6px;
    color:var(--muted);
    font-size:12px;
  }

  /* weather icon / preview */
  .preview{
    display:flex;
    align-items:center;
    gap:10px;
  }

  /* small pill */
  .pill{
    padding:6px 10px;
    border-radius:999px;
    background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.03);
    font-size:13px;
    color:var(--muted);
    display:inline-flex;
    gap:8px;
    align-items:center;
  }

  /* Animated sun/cloud (svg) */
  .scene-svg{ width:100%; height:100%; display:block; }

  /* small accessibility */
  .sr-only{ position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0; }

  /* transitions for card content fade when weather switches */
  .fade {
    transition: opacity var(--transition), transform var(--transition);
  }
  .fade.hidden { opacity:0; transform: translateY(8px) scale(.995); pointer-events:none; }

  /* weather-specific small details */
  /* Sunny: bright accents */
  body.mode-sunny .temp{ color: #fff;}
  /* Rain: muted */
  body.mode-rainy .temp{ color: #dbe9ff; }
  body.mode-rainy .card{ box-shadow: 0 10px 40px rgba(0,0,0,0.7); }
  /* Snow: cool */
  body.mode-snowy .temp{ color: #f6fbff; text-shadow: 0 1px 0 rgba(0,0,0,0.15); }
  /* Wind: pale greenish */
  body.mode-windy .temp{ color: #e8fff3; }

  /* Hover & focus outlines for accessibility */
  .btn:focus{ outline: 3px solid rgba(255,255,255,0.06); outline-offset:3px; }

  /* small responsive tweaks */
  @media (max-width:740px){
    .temp{ font-size: clamp(36px, 12vw, 56px); }
    .card{ padding:16px; }
  }

  /* Reduce animation for users wanting less motion */
  @media (prefers-reduced-motion: reduce){
    :root{ --transition: 150ms linear; }
    .btn:hover{ transform:none; box-shadow:none; }
    .layer{ transition:none !important; }
  }
</style>
</head>
<body class="mode-sunny">
  <!-- Fullscreen animated stage -->
  <div class="weather-stage" aria-hidden="true">
    <!-- Sunny: sun + slow clouds -->
    <div id="layer-sunny" class="layer visible">
      <svg class="scene-svg" viewBox="0 0 1600 900" preserveAspectRatio="xMidYMid slice" style="position:absolute; inset:0; width:100%; height:100%;">
        <defs>
          <linearGradient id="sunGrad" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0" stop-color="#fff5c2" stop-opacity="0.95"></stop>
            <stop offset="1" stop-color="#ffd58a" stop-opacity="0.85"></stop>
          </linearGradient>
          <filter id="soft" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="30" result="b"/>
            <feBlend in="SourceGraphic" in2="b"/>
          </filter>
        </defs>
        <!-- subtle gradient glow -->
        <rect width="100%" height="100%" fill="none"></rect>

        <!-- sun -->
        <g id="sun" transform="translate(1200,180)">
          <circle cx="0" cy="0" r="64" fill="url(#sunGrad)" filter="url(#soft)"></circle>
          <g id="sun-rays" style="transform-origin: 0px 0px;">
            <!-- rays -->
            <g style="opacity:.12;">
              <g>
                <rect x="-6" y="-120" width="12" height="40" rx="6" transform="rotate(0)"></rect>
                <rect x="-6" y="-120" width="12" height="40" rx="6" transform="rotate(30)"></rect>
                <rect x="-6" y="-120" width="12" height="40" rx="6" transform="rotate(60)"></rect>
                <rect x="-6" y="-120" width="12" height="40" rx="6" transform="rotate(90)"></rect>
                <rect x="-6" y="-120" width="12" height="40" rx="6" transform="rotate(120)"></rect>
                <rect x="-6" y="-120" width="12" height="40" rx="6" transform="rotate(150)"></rect>
                <rect x="-6" y="-120" width="12" height="40" rx="6" transform="rotate(180)"></rect>
              </g>
            </g>
          </g>
        </g>

        <!-- gentle clouds drifting -->
        <g id="clouds" transform="translate(200,200)" opacity="0.95">
          <g class="cloud" transform="translate(0,0) scale(1)">
            <ellipse cx="0" cy="0" rx="76" ry="42" fill="rgba(255,255,255,0.06)"></ellipse>
            <ellipse cx="50" cy="-6" rx="52" ry="30" fill="rgba(255,255,255,0.06)"></ellipse>
            <ellipse cx="-48" cy="-8" rx="40" ry="26" fill="rgba(255,255,255,0.06)"></ellipse>
          </g>
          <g class="cloud" transform="translate(360,80) scale(.8)">
            <ellipse cx="0" cy="0" rx="86" ry="44" fill="rgba(255,255,255,0.05)"></ellipse>
            <ellipse cx="54" cy="-10" rx="42" ry="26" fill="rgba(255,255,255,0.05)"></ellipse>
            <ellipse cx="-46" cy="-6" rx="48" ry="28" fill="rgba(255,255,255,0.05)"></ellipse>
          </g>
          <g class="cloud" transform="translate(720,130) scale(1.1)">
            <ellipse cx="0" cy="0" rx="96" ry="48" fill="rgba(255,255,255,0.04)"></ellipse>
            <ellipse cx="64" cy="-12" rx="52" ry="28" fill="rgba(255,255,255,0.04)"></ellipse>
            <ellipse cx="-64" cy="-10" rx="52" ry="28" fill="rgba(255,255,255,0.04)"></ellipse>
          </g>
        </g>
      </svg>
    </div>

    <!-- Rain: canvas -->
    <canvas id="layer-rain" class="layer" ></canvas>

    <!-- Snow: canvas -->
    <canvas id="layer-snow" class="layer"></canvas>

    <!-- Wind: canvas -->
    <canvas id="layer-wind" class="layer"></canvas>
  </div>

  <!-- Page content -->
  <div class="wrap">
    <div class="card" role="region" aria-label="天气卡片">
      <!-- Left: main info -->
      <div class="card-main">
        <div class="city">
          <svg class="ico" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M12 2L3 6v6c0 5 4 9 9 10s9-4 9-9V6l-9-4z" opacity=".12"></path>
            <path fill="currentColor" d="M12 2L3 6v6c0 5 4 9 9 10s9-4 9-9V6l-9-4z" fill="none"></path>
          </svg>
          <div>
            <h1 id="city-name">上海</h1>
            <div class="muted" id="time-local">2025-08-08 · 早上 09:00</div>
          </div>
        </div>

        <div class="temp-row" style="align-items:center;">
          <div>
            <div class="temp" id="temp">25°C</div>
            <div class="desc" id="desc">局部多云</div>
          </div>

          <div style="margin-left:auto;">
            <div class="preview pill" title="当前天气">
              <svg id="mini-icon" class="ico" viewBox="0 0 48 48" aria-hidden="true"></svg>
              <div class="meta" id="feels">体感: 25°C</div>
            </div>
          </div>
        </div>

        <div class="foot muted">高级天气卡片示例 — 用于展示并替换占位数据。样式与动画均可按需调整。</div>
      </div>

      <!-- Right: controls -->
      <aside class="card-side" aria-label="天气控制">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div class="meta">选择天气模式</div>
          <div class="meta" id="reduced">动画: 普通</div>
        </div>

        <div class="controls" role="tablist" aria-label="天气切换">
          <button class="btn" id="btn-sunny" role="tab" aria-pressed="true" data-mode="sunny" title="晴天">
            <svg class="ico" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4" fill="currentColor"></circle></svg>
            晴天
          </button>
          <button class="btn" id="btn-rainy" role="tab" aria-pressed="false" data-mode="rainy" title="雨天">
            <svg class="ico" viewBox="0 0 24 24"><path d="M5 16a4 4 0 0 1 8 0h2a6 6 0 1 0-12 0z" fill="currentColor" /></svg>
            雨天
          </button>
          <button class="btn" id="btn-snowy" role="tab" aria-pressed="false" data-mode="snowy" title="下雪">
            <svg class="ico" viewBox="0 0 24 24"><path d="M12 2v20M2 12h20M4.2 4.2l15.6 15.6M19.8 4.2L4.2 19.8" stroke="currentColor" stroke-width="1.2" fill="none"></path></svg>
            下雪
          </button>
          <button class="btn" id="btn-windy" role="tab" aria-pressed="false" data-mode="windy" title="大风">
            <svg class="ico" viewBox="0 0 24 24"><path d="M3 12h12a3 3 0 0 0 0-6 3 3 0 0 0-2.83 2H9" stroke="currentColor" stroke-width="1.2" fill="none"></path></svg>
            大风
          </button>
        </div>

        <div>
          <div class="meta" style="margin-bottom:8px;">示例信息（可替换）</div>
          <div style="display:flex; gap:8px;">
            <button class="btn" id="btn-update" title="更新占位数据">更新占位</button>
            <button class="btn" id="btn-toggle-motion" title="切换动画模式">减少动画</button>
          </div>
        </div>

        <div style="margin-top:auto;">
          <div class="muted">交互提示：按钮有 hover 与按下反馈。卡片为深色毛玻璃风格。</div>
        </div>
      </aside>
    </div>
  </div>

<script>
/*
  Weather Card JS
  - Handles mode switching, transitions, accessibility attributes
  - Implements canvas animations for rain/snow/wind
  - Keeps everything single-file, zero-deps
*/

(() => {
  // -- Config / placeholders
  const state = {
    mode: 'sunny', // 'sunny'|'rainy'|'snowy'|'windy'
    temp: '25°C',
    city: '上海',
    desc: '局部多云',
    feels: '25°C',
    reducedMotion: false
  };

  // Elements
  const body = document.body;
  const layerSunny = document.getElementById('layer-sunny');
  const layerRain = document.getElementById('layer-rain');
  const layerSnow = document.getElementById('layer-snow');
  const layerWind = document.getElementById('layer-wind');

  const allLayers = {
    sunny: layerSunny,
    rainy: layerRain,
    snowy: layerSnow,
    windy: layerWind
  };

  const btns = Array.from(document.querySelectorAll('.btn[data-mode]'));
  const btnUpdate = document.getElementById('btn-update');
  const btnToggleMotion = document.getElementById('btn-toggle-motion');
  const reducedText = document.getElementById('reduced');

  // info spans
  const cityName = document.getElementById('city-name');
  const tempEl = document.getElementById('temp');
  const descEl = document.getElementById('desc');
  const feelsEl = document.getElementById('feels');
  const miniIcon = document.getElementById('mini-icon');
  const timeLocal = document.getElementById('time-local');

  // Accessibility: set initial body class
  function setBodyMode(m){
    body.classList.remove('mode-sunny','mode-rainy','mode-snowy','mode-windy');
    body.classList.add('mode-' + m);
  }

  // Fade logic: show target layer, hide others with opacity transition
  function showLayer(name){
    Object.keys(allLayers).forEach(k=>{
      const el = allLayers[k];
      if(!el) return;
      if(k === name){
        // force visible
        el.classList.add('visible');
      } else {
        el.classList.remove('visible');
      }
    });
  }

  // Update UI placeholders
  function refreshInfo(){
    cityName.textContent = state.city;
    tempEl.textContent = state.temp;
    descEl.textContent = state.desc;
    feelsEl.textContent = '体感: ' + state.feels;
    timeLocal.textContent = (new Date()).toLocaleString();
    // set mini icon
    renderMiniIcon(state.mode);
  }

  // Buttons press state
  function setActiveButton(mode){
    btns.forEach(b=>{
      const m = b.dataset.mode;
      const pressed = (m === mode);
      b.setAttribute('aria-pressed', pressed ? 'true' : 'false');
    });
  }

  // Render mini svg icon
  function renderMiniIcon(mode){
    miniIcon.innerHTML = '';
    if(mode === 'sunny'){
      miniIcon.innerHTML = '<circle cx="24" cy="24" r="8" fill="currentColor"/>';
    } else if(mode === 'rainy'){
      miniIcon.innerHTML = '<path d="M16 18c0-3.3 2.7-6 6-6s6 2.7 6 6" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 30c0 0 3-6 3-8" stroke="currentColor" stroke-width="2" fill="none"/>';
    } else if(mode === 'snowy'){
      miniIcon.innerHTML = '<path d="M24 16v16M16 20l16 8M16 28l16-8" stroke="currentColor" stroke-width="1.6" fill="none"/>';
    } else if(mode === 'windy'){
      miniIcon.innerHTML = '<path d="M6 18h12a4 4 0 0 0 0-8 4 4 0 0 0-3 1.4" stroke="currentColor" stroke-width="1.6" fill="none"/>';
    }
  }

  // --- MODE SWITCH ---
  function switchMode(mode){
    if(state.mode === mode) return;
    // smooth transition: fade content
    const leftMain = document.querySelector('.card-main');
    const right = document.querySelector('.card-side');
    leftMain.classList.add('hidden','fade');
    right.classList.add('hidden','fade');
    setTimeout(()=>{ leftMain.classList.remove('hidden'); right.classList.remove('hidden'); }, 300);

    state.mode = mode;
    setBodyMode(mode);
    setActiveButton(mode);
    showLayer(mode);
    renderMiniIcon(mode);
    // start/stop animations handled by canvases controllers
    updateAnimationState();
  }

  // Buttons wiring
  btns.forEach(b=>{
    b.addEventListener('click', (e)=>{
      const mode = b.dataset.mode;
      switchMode(mode);
    });
    b.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); b.click(); }
    });
  });

  // -- Update placeholders (demo) --
  btnUpdate.addEventListener('click', ()=>{
    // simple cycle demo of placeholder data
    const samples = [
      {city:'上海', temp:'25°C', desc:'局部多云', feels:'25°C'},
      {city:'北京', temp:'18°C', desc:'小雨', feels:'17°C'},
      {city:'哈尔滨', temp:'-6°C', desc:'小雪', feels:'-10°C'},
      {city:'成都', temp:'30°C', desc:'大风', feels:'31°C'}
    ];
    const s = samples[Math.floor(Math.random()*samples.length)];
    state.city = s.city;
    state.temp = s.temp;
    state.desc = s.desc;
    state.feels = s.feels;
    refreshInfo();
  });

  // Toggle reduced motion
  btnToggleMotion.addEventListener('click', ()=>{
    state.reducedMotion = !state.reducedMotion;
    reducedText.textContent = '动画: ' + (state.reducedMotion ? '减少' : '普通');
    // apply via attribute
    if(state.reducedMotion){
      document.documentElement.style.setProperty('--glass-blur','6px');
    } else {
      document.documentElement.style.setProperty('--glass-blur','12px');
    }
    // inform canvases
    rainController && rainController.setReduced(state.reducedMotion);
    snowController && snowController.setReduced(state.reducedMotion);
    windController && windController.setReduced(state.reducedMotion);
  });

  // initial render
  refreshInfo();
  setActiveButton(state.mode);

  // --- Canvas animations controllers ---
  // Utility: resize canvas to full window dpr aware
  function fitCanvas(canvas){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.ceil(rect.width * dpr);
    canvas.height = Math.ceil(rect.height * dpr);
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';
    return dpr;
  }

  // Set each canvas to fill viewport
  [layerRain, layerSnow, layerWind].forEach(c => {
    if(!c) return;
    c.style.position = 'absolute';
    c.style.inset = '0';
    c.style.width = '100%';
    c.style.height = '100%';
    c.style.display = 'block';
    c.style.zIndex = 0;
    c.style.pointerEvents = 'none';
  });

  // RAIN controller
  function createRain(canvas){
    const ctx = canvas.getContext('2d');
    let particles = [];
    let running = false;
    let rafId = null;
    let reduced = false;

    function spawn(w,h){
      const density = reduced ? 0.6 : 1; // scale
      const count = Math.floor((w * h) / (8000 / density));
      particles = [];
      for(let i=0;i<count;i++){
        particles.push({
          x: Math.random() * w,
          y: Math.random() * h,
          len: 10 + Math.random() * 18,
          speed: 350 + Math.random()*600,
          xs: -0.6 + Math.random()*-1.6,
          opacity: 0.1 + Math.random()*0.6,
        });
      }
    }

    function setReduced(r){ reduced = r; spawn(canvas.width, canvas.height); }

    function tick(t){
      if(!running) return;
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0,0,w,h);

      // subtle vertical blur for rain effect
      for(let p of particles){
        p.x += p.xs;
        p.y += (p.speed / 1000) * (reduced ? 0.6 : 1.0); // speed per frame
        // wrap
        if(p.y > h + 50 || p.x < -100 || p.x > w + 100){
          p.x = Math.random()*w;
          p.y = -30 - Math.random()*300;
        }
        ctx.beginPath();
        ctx.globalAlpha = p.opacity * 0.9;
        ctx.strokeStyle = 'rgba(180,200,255,0.75)';
        ctx.lineWidth = 1.2 * dpr;
        ctx.moveTo(p.x, p.y);
        ctx.lineTo(p.x + p.xs*6, p.y + p.len);
        ctx.stroke();
      }
      rafId = requestAnimationFrame(tick);
    }

    function start(){
      running = true;
      fitCanvas(canvas);
      spawn(canvas.width, canvas.height);
      if(rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(tick);
    }
    function stop(){
      running = false;
      if(rafId) cancelAnimationFrame(rafId);
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }
    // resize handler
    function resize(){
      const dpr = fitCanvas(canvas);
      spawn(canvas.width, canvas.height);
    }

    window.addEventListener('resize', resize);
    // initial
    resize();

    return { start, stop, setReduced };
  }

  // SNOW controller
  function createSnow(canvas){
    const ctx = canvas.getContext('2d');
    let flakes = [];
    let running = false;
    let rafId = null;
    let reduced = false;

    function spawn(w,h){
      const density = reduced ? 0.35 : 0.9;
      const count = Math.floor((w * h) / (30000 / density));
      flakes = [];
      for(let i=0;i<count;i++){
        flakes.push({
          x: Math.random()*w,
          y: Math.random()*h,
          r: 1 + Math.random()*4,
          speed: 10 + Math.random()*40,
          drift: -0.5 + Math.random()*1.0,
          angle: Math.random()*Math.PI*2,
        });
      }
    }

    function setReduced(r){ reduced = r; spawn(canvas.width, canvas.height); }

    function tick(){
      if(!running) return;
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0,0,w,h);
      ctx.globalAlpha = 0.95;
      for(let f of flakes){
        f.x += f.drift * (reduced?0.4:1.0) * (f.r*0.2);
        f.y += (f.speed/60) * (reduced?0.6:1);
        f.angle += 0.01;
        if(f.y > h + 20){ f.y = -10; f.x = Math.random()*w; }
        ctx.beginPath();
        ctx.fillStyle = 'rgba(255,255,255,0.9)';
        ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
        ctx.fill();
      }
      rafId = requestAnimationFrame(tick);
    }

    function start(){
      running = true;
      fitCanvas(canvas);
      spawn(canvas.width, canvas.height);
      if(rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(tick);
    }
    function stop(){
      running = false;
      if(rafId) cancelAnimationFrame(rafId);
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }
    function resize(){
      fitCanvas(canvas);
      spawn(canvas.width, canvas.height);
    }
    window.addEventListener('resize', resize);
    resize();
    return { start, stop, setReduced };
  }

  // WIND controller (leaves / particles)
  function createWind(canvas){
    const ctx = canvas.getContext('2d');
    let leaves = [];
    let running = false;
    let rafId = null;
    let reduced = false;

    function spawn(w,h){
      const density = reduced ? 0.3 : 0.7;
      const count = Math.floor((w * h) / (90000 / density));
      leaves = [];
      for(let i=0;i<count;i++){
        leaves.push({
          x: Math.random()*w,
          y: Math.random()*h,
          vx: 0.6 + Math.random()*3.0,
          vy: -0.2 + Math.random()*0.8,
          rot: Math.random()*Math.PI*2,
          vs: 0.01 + Math.random()*0.04,
          s: 6 + Math.random()*14,
          hue: 90 + Math.random()*40
        });
      }
    }

    function setReduced(r){ reduced = r; spawn(canvas.width, canvas.height); }

    function tick(){
      if(!running) return;
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0,0,w,h);
      for(let lf of leaves){
        lf.x += lf.vx * (reduced?0.6:1);
        lf.y += lf.vy * (reduced?0.6:1);
        lf.rot += lf.vs * (reduced?0.6:1);
        if(lf.x > w + 30 || lf.y < -60 || lf.y > h + 60){
          lf.x = -40 - Math.random()*200;
          lf.y = Math.random()*h;
        }
        // draw leaf simple
        ctx.save();
        ctx.translate(lf.x, lf.y);
        ctx.rotate(lf.rot);
        ctx.beginPath();
        ctx.ellipse(0,0, lf.s, lf.s*0.6, 0, 0, Math.PI*2);
        ctx.fillStyle = 'hsla(' + lf.hue + ', 60%, 60%, 0.95)';
        ctx.fill();
        ctx.restore();
      }
      rafId = requestAnimationFrame(tick);
    }

    function start(){
      running = true;
      fitCanvas(canvas);
      spawn(canvas.width, canvas.height);
      if(rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(tick);
    }
    function stop(){
      running = false;
      if(rafId) cancelAnimationFrame(rafId);
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }
    function resize(){
      fitCanvas(canvas);
      spawn(canvas.width, canvas.height);
    }
    window.addEventListener('resize', resize);
    resize();
    return { start, stop, setReduced };
  }

  // Initialize controllers
  const rainController = createRain(layerRain);
  const snowController = createSnow(layerSnow);
  const windController = createWind(layerWind);

  // Start/stop based on visible mode
  function updateAnimationState(){
    // stop all first
    rainController.stop();
    snowController.stop();
    windController.stop();
    // small timeout to allow CSS opacity to crossfade smoothly
    setTimeout(()=>{
      if(state.mode === 'rainy') rainController.start();
      if(state.mode === 'snowy') snowController.start();
      if(state.mode === 'windy') windController.start();
      // sunny uses svg animations already visible; no canvas required
    }, 120);
  }

  // initial start for sunny (SVG animated)
  function startSunnySvg(){
    // simple cloud drift & sun rays rotate
    const clouds = document.querySelectorAll('#clouds .cloud');
    clouds.forEach((c,i)=>{
      const dur = 30 + i*12;
      c.animate([
        { transform: c.getAttribute('transform') + ' translate(0,0)' },
        { transform: c.getAttribute('transform') + ' translate(60,0)' },
        { transform: c.getAttribute('transform') + ' translate(0,0)' }
      ], {
        duration: dur * 1000,
        iterations: Infinity,
        direction: 'alternate',
        easing: 'ease-in-out'
      });
    });
    const rays = document.querySelector('#sun-rays');
    if(rays){
      rays.animate([
        { transform: 'rotate(0deg)' },
        { transform: 'rotate(360deg)' }
      ], {
        duration: 40000,
        iterations: Infinity,
        easing: 'linear'
      });
    }
  }
  startSunnySvg();

  // initial call to set visibility
  showLayer(state.mode);
  updateAnimationState();

  // expose to window for debugging (optional)
  window.__weatherCard = { switchMode, state };

  // ensure canvas layers initially hidden (except sunny)
  layerRain.classList.remove('visible');
  layerSnow.classList.remove('visible');
  layerWind.classList.remove('visible');

  // ensure window resize adjusts canvas
  window.addEventListener('resize', ()=> {
    [layerRain, layerSnow, layerWind].forEach(c => { if(c) fitCanvas(c); });
  });

  // direct keyboard: numbers 1-4 to switch
  window.addEventListener('keydown', (e)=>{
    if(e.key === '1') document.getElementById('btn-sunny').click();
    if(e.key === '2') document.getElementById('btn-rainy').click();
    if(e.key === '3') document.getElementById('btn-snowy').click();
    if(e.key === '4') document.getElementById('btn-windy').click();
  });

})();
</script>
</body>
</html>