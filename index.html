<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>动态天气</title>
<style>
  html,body{margin:0;padding:0;height:100%;font-family:"Segoe UI",sans-serif;color:#333;overflow-x:hidden}
  body{position:relative;transition:background 0.6s ease}
  canvas{position:fixed;top:0;left:0;z-index:-1}
  .container{max-width:900px;margin:auto;padding:20px}
  .card{background:rgba(255,255,255,0.85);border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 8px 20px rgba(0,0,0,0.1)}
  .title{font-size:1.5em;font-weight:bold;margin-bottom:10px}
  .weather-main{display:flex;justify-content:space-between;align-items:center}
  .weather-temp{font-size:2.5em;font-weight:bold}
  .forecast{display:flex;overflow-x:auto;gap:10px}
  .forecast-item{flex:0 0 auto;background:rgba(255,255,255,0.9);border-radius:10px;padding:10px;text-align:center;width:100px;box-shadow:0 4px 10px rgba(0,0,0,0.05)}
  #city-error{color:#d9534f;margin-top:5px;font-size:14px;display:none}
</style>
</head>
<body>
<canvas id="weatherCanvas"></canvas>

<div class="container">
  <div class="card" id="location-card">
    <div class="title">当前位置</div>
    <div id="location-display" style="display: flex; justify-content: space-between; align-items: center;">
      <div id="location">正在根据IP获取定位...</div>
      <div id="datetime" style="font-size:0.9em;color:#666;"></div>
    </div>
    <div style="margin-top:15px;">
      <div style="display:flex;gap:10px;align-items:center;">
        <input id="city-input" type="text" placeholder="请输入城市名称" style="padding:8px;flex:1;border:1px solid #ddd;border-radius:5px">
        <button id="search-city" style="padding:8px 15px;background:#4facfe;color:#fff;border:none;border-radius:5px">查询</button>
      </div>
      <p id="city-error">错误信息</p>
    </div>
  </div>

  <div class="card">
    <div class="title">实时天气</div>
    <div class="weather-main">
      <div>
        <div id="temp" class="weather-temp">--°C</div>
        <div id="desc">--</div>
      </div>
      <div id="icon" style="font-size:48px">☀️</div>
    </div>
  </div>

  <div class="card">
    <div class="title">未来48小时</div>
    <div id="hourly" class="forecast"></div>
  </div>

  <div class="card">
    <div class="title">未来3天</div>
    <div id="daily" class="forecast"></div>
  </div>
</div>

<script>
/* ====== 保留你原来的 API keys ====== */
const API_KEY = "0nRahTS8MYHrujeP"; // 彩云天气（JSONP）
const GAODE_API_KEY = "bd5388dfef81ab0f12b81ff9d179b61b"; // 高德地图

/* ====== 画布与状态 ====== */
const canvas = document.getElementById('weatherCanvas');
const ctx = canvas.getContext('2d');
let particles = [];
let _lightningInterval = null;
let _lightningFlash = 0;
let _lastWeatherScriptId = null;
let _currentWeatherCity = ''; // 当前请求的城市名（用于特效判断）
resizeCanvas();
window.addEventListener('resize', resizeCanvas);
function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

/* ====== 清理/特效工厂 ====== */
function clearEffects(){
  particles = [];
  if (_lightningInterval) { clearInterval(_lightningInterval); _lightningInterval = null; }
  _lightningFlash = 0;
}
function createRain(count=160){
  for(let i=0;i<count;i++){
    particles.push({type:'rain', x:Math.random()*canvas.width, y:Math.random()*canvas.height, len:Math.random()*20+12, speed:Math.random()*4+6, alpha: Math.random()*0.5+0.35});
  }
}
function createSnow(count=120){
  for(let i=0;i<count;i++){
    particles.push({type:'snow', x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*3+1, speed:Math.random()*0.6+0.3});
  }
}
function createSnowGlow(count=28){
  for(let i=0;i<count;i++){
    particles.push({type:'snowglow', x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*4+3, speed:Math.random()*0.4+0.1});
  }
}
function createFloatingLights(count=60){
  for(let i=0;i<count;i++){
    particles.push({type:'light', x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*1.8+0.8, speed:Math.random()*0.4+0.1, alpha: Math.random()*0.6+0.3});
  }
}
function createClouds(count=8){
  for(let i=0;i<count;i++){
    particles.push({type:'cloud', x:Math.random()*canvas.width, y:Math.random()*canvas.height*0.6, r:Math.random()*80+60, speed:(Math.random()*0.3+0.03), alpha: Math.random()*0.25+0.12});
  }
}
function createLightning(){
  if (_lightningInterval) clearInterval(_lightningInterval);
  // 随机间隔触发短时闪光（使用 _lightningFlash 控制帧数）
  _lightningInterval = setInterval(()=>{
    // 30% 概率触发闪电，这样不会太频繁
    if (Math.random() < 0.35) _lightningFlash = Math.floor(2 + Math.random()*5);
  }, 2200 + Math.random()*3000);
}

/* ====== 根据 skycon 与城市设置效果 ====== */
function setBackgroundEffect(skycon = "", cityName = ""){
  clearEffects();
  skycon = (skycon || "").toUpperCase();
  cityName = cityName || "";
  if(skycon.includes("RAIN")){
    createRain(160);
    createClouds(6);
    createLightning();
  } else if(skycon.includes("SNOW")){
    createSnow(120);
    createSnowGlow(28);
    createClouds(5);
  } else if(skycon.includes("CLEAR")){
    createFloatingLights(60);
    createClouds(4);
  } else if(skycon.includes("CLOUD")){
    createClouds(10);
  } else {
    createClouds(6);
  }
  // 北京增强效果（可按需调整）
  if(/北京/.test(cityName)){
    if(skycon.includes("CLEAR")) createFloatingLights(40);
    if(skycon.includes("RAIN")) createClouds(10);
  }
}

/* ====== 背景颜色 ====== */
function setBackgroundColor(skycon = ""){
  const map = {
    "CLEAR_DAY":"linear-gradient(to bottom,#4facfe,#00f2fe)",
    "CLEAR_NIGHT":"linear-gradient(to bottom,#0f2027,#203a43)",
    "PARTLY_CLOUDY_DAY":"linear-gradient(to bottom,#a1c4fd,#c2e9fb)",
    "PARTLY_CLOUDY_NIGHT":"linear-gradient(to bottom,#2c3e50,#4ca1af)",
    "CLOUDY":"linear-gradient(to bottom,#cfd9df,#e2ebf0)",
    "RAIN":"linear-gradient(to bottom,#00c6fb,#005bea)",
    "SNOW":"linear-gradient(to bottom,#e0f7ff,#f7fbff)"
  };
  document.body.style.background = map[skycon] || "linear-gradient(to bottom,#a0cfff,#ffffff)";
}

/* ====== 渲染循环 ====== */
function animate(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // 闪电覆盖层
  if(_lightningFlash > 0){
    ctx.fillStyle = `rgba(255,255,255,${0.12 + Math.random()*0.3})`;
    ctx.fillRect(0,0,canvas.width,canvas.height);
    _lightningFlash--;
  }

  for(let p of particles){
    if(p.type === 'rain'){
      ctx.beginPath();
      ctx.strokeStyle = `rgba(174,194,224,${p.alpha})`;
      ctx.lineWidth = 1;
      ctx.moveTo(p.x, p.y);
      ctx.lineTo(p.x, p.y + p.len);
      ctx.stroke();
      p.y += p.speed;
      p.x += Math.sin(p.y/20)*0.6;
      if(p.y > canvas.height + p.len) { p.y = -p.len; p.x = Math.random()*canvas.width; }
    } else if(p.type === 'snow'){
      ctx.beginPath();
      ctx.fillStyle = "rgba(255,255,255,0.9)";
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();
      p.y += p.speed;
      p.x += Math.sin(p.y/30)*0.3;
      if(p.y > canvas.height + p.r) { p.y = -p.r; p.x = Math.random()*canvas.width; }
    } else if(p.type === 'snowglow'){
      ctx.save();
      ctx.beginPath();
      ctx.shadowColor = "white";
      ctx.shadowBlur = 12;
      ctx.fillStyle = "rgba(255,255,255,0.95)";
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
      ctx.restore();
      p.y += p.speed;
      if(p.y > canvas.height + p.r) { p.y = -p.r; p.x = Math.random()*canvas.width; }
    } else if(p.type === 'light'){
      ctx.beginPath();
      ctx.fillStyle = `rgba(255,255,200,${p.alpha})`;
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
      p.y += p.speed;
      p.x += Math.sin(p.y/60)*0.2;
      if(p.y > canvas.height + p.r) { p.y = -p.r; p.x = Math.random()*canvas.width; }
    } else if(p.type === 'cloud'){
      ctx.save();
      ctx.globalAlpha = p.alpha;
      ctx.beginPath();
      ctx.ellipse(p.x, p.y, p.r*1.6, p.r, 0, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255,255,255,0.85)';
      ctx.fill();
      ctx.restore();
      p.x += p.speed;
      if(p.x - p.r*2 > canvas.width) p.x = -p.r*2;
    }
  }

  requestAnimationFrame(animate);
}
animate();

/* ====== JSONP: 请求与回调管理 ====== */
function fetchWeather(lat, lon, cityName = ""){
  // 清理上一次 jsonp script（避免堆积）
  if(_lastWeatherScriptId){
    const old = document.getElementById(_lastWeatherScriptId);
    if(old) old.remove();
    _lastWeatherScriptId = null;
  }
  _currentWeatherCity = cityName || '';
  const id = 'caiyun-jsonp-' + Date.now();
  _lastWeatherScriptId = id;
  const script = document.createElement('script');
  script.id = id;
  script.src = `https://api.caiyunapp.com/v2.6/${API_KEY}/${lon},${lat}/weather.jsonp?callback=MYCALLBACK`;
  script.onerror = () => {
    document.getElementById('city-error').textContent = '天气数据加载失败';
    document.getElementById('city-error').style.display = 'block';
  };
  document.body.appendChild(script);
}

/* 全局回调（彩云 JSONP 会调用 MYCALLBACK） */
function MYCALLBACK(data){
  // 清理 jsonp script（已加载）
  if(_lastWeatherScriptId){
    const s = document.getElementById(_lastWeatherScriptId);
    if(s) s.remove();
    _lastWeatherScriptId = null;
  }
  document.getElementById('city-error').style.display = 'none';

  if(!data || !data.result){
    document.getElementById('city-error').textContent = '天气数据异常';
    document.getElementById('city-error').style.display = 'block';
    return;
  }

  const realtime = data.result.realtime || {};
  const hourly = data.result.hourly || {};
  const daily = data.result.daily || {};

  document.getElementById('temp').textContent = (realtime.temperature !== undefined) ? `${realtime.temperature}°C` : '--°C';
  const skycon = (realtime.skycon || '').toUpperCase();
  document.getElementById('desc').textContent = skyconToChinese(skycon);
  document.getElementById('icon').textContent = skyconEmoji(skycon);

  // 背景颜色与特效，基于当前请求的城市名（_currentWeatherCity）
  setBackgroundColor(skycon);
  setBackgroundEffect(skycon, _currentWeatherCity);

  // 填充小时预报
  const hourlyDiv = document.getElementById('hourly');
  hourlyDiv.innerHTML = '';
  if(hourly.temperature && hourly.temperature.length){
    const len = Math.min(hourly.temperature.length, (hourly.skycon && hourly.skycon.length) ? hourly.skycon.length : hourly.temperature.length);
    for(let i=0;i<len;i++){
      const tObj = hourly.temperature[i];
      const timeStr = tObj && tObj.datetime ? new Date(tObj.datetime).getHours() + '时' : (i + 'h');
      const tVal = tObj && (tObj.value !== undefined) ? `${tObj.value}°C` : '--';
      const skyVal = (hourly.skycon && hourly.skycon[i] && hourly.skycon[i].value) ? hourly.skycon[i].value : '';
      const div = document.createElement('div');
      div.className = 'forecast-item';
      div.innerHTML = `<div>${timeStr}</div><div>${skyconEmoji(skyVal)}</div><div>${tVal}</div><div style="font-size:12px">${skyconToChinese(skyVal)}</div>`;
      hourlyDiv.appendChild(div);
    }
  } else {
    hourlyDiv.innerHTML = '<div class="forecast-item">无小时数据</div>';
  }

  // 填充日预报
  const dailyDiv = document.getElementById('daily');
  dailyDiv.innerHTML = '';
  if(daily.temperature && daily.temperature.length){
    // 只显示前 7 天的数据
    const len = Math.min(daily.temperature.length, 3);
    for(let i=0;i<len;i++){
      const tObj = daily.temperature[i];
      const dateStr = tObj && tObj.date ? new Date(tObj.date).toLocaleDateString() : ('第' + (i+1) + '天');
      const tMax = tObj && (tObj.max !== undefined) ? tObj.max : '--';
      const tMin = tObj && (tObj.min !== undefined) ? tObj.min : '--';
      const skyVal = (daily.skycon && daily.skycon[i] && daily.skycon[i].value) ? daily.skycon[i].value : '';
      const div = document.createElement('div');
      div.className = 'forecast-item';
      div.innerHTML = `<div>${dateStr}</div><div>${skyconEmoji(skyVal)}</div><div>${tMax} / ${tMin}°C</div><div style="font-size:12px">${skyconToChinese(skyVal)}</div>`;
      dailyDiv.appendChild(div);
    }
  } else {
    dailyDiv.innerHTML = '<div class="forecast-item">无日数据</div>';
  }
}

/* ====== skycon 辅助 ====== */
function skyconEmoji(skycon){
  if(!skycon) return '—';
  const map = {'CLEAR_DAY':'☀️','CLEAR_NIGHT':'🌙','PARTLY_CLOUDY_DAY':'⛅','PARTLY_CLOUDY_NIGHT':'☁️','CLOUDY':'☁️','RAIN':'🌧️','SNOW':'❄️','HAZE':'🌫️','LIGHT_RAIN':'🌦️'};
  return map[skycon] || '☀️';
}
function skyconToChinese(skycon){
  if(!skycon) return '未知';
  const map = {'CLEAR_DAY':'晴天','CLEAR_NIGHT':'晴(夜)','PARTLY_CLOUDY_DAY':'多云','PARTLY_CLOUDY_NIGHT':'多云(夜)','CLOUDY':'阴天','RAIN':'降雨','SNOW':'降雪','HAZE':'雾霾'};
  return map[skycon] || skycon;
}

/* ====== 城市/经纬互转（高德） ====== */
function getLocationByCity(cityName){
  cityName = (cityName || '').trim();
  if(!cityName){
    document.getElementById('city-error').textContent = '请输入有效城市名称';
    document.getElementById('city-error').style.display = 'block';
    return;
  }
  document.getElementById('city-error').style.display = 'none';
  document.getElementById('location').textContent = `正在获取 ${cityName} 的位置信息...`;
  const url = `https://restapi.amap.com/v3/geocode/geo?key=${GAODE_API_KEY}&address=${encodeURIComponent(cityName)}`;
  fetch(url).then(r=>r.json()).then(data=>{
    if(data && data.status === '1' && data.geocodes && data.geocodes.length>0){
      const loc = data.geocodes[0].location || '';
      const [lon,lat] = loc.split(','); // 高德是lon,lat顺序
      document.getElementById('location').textContent = `城市: ${cityName}`;
      fetchWeather(lat, lon, cityName);
    } else {
      document.getElementById('city-error').textContent = `未找到 ${cityName} 的位置信息`;
      document.getElementById('city-error').style.display = 'block';
      document.getElementById('location').textContent = '定位失败';
    }
  }).catch(err=>{
    console.error('高德地理编码失败', err);
    document.getElementById('city-error').textContent = '获取位置信息失败';
    document.getElementById('city-error').style.display = 'block';
    document.getElementById('location').textContent = '定位失败';
  });
}


/* ====== 核心改动：新的 IP 定位函数 ====== */
function getLocationByIp(){
  document.getElementById('location').textContent = '正在取定位...';
  // 采用一个免费的IP定位服务
  fetch('https://api.ip.sb/geoip').then(r => r.json()).then(data => {
    if(data && data.latitude !== undefined && data.longitude !== undefined){
      const lat = data.latitude;
      const lon = data.longitude;
      const city = data.city || data.region || '未知城市';
      document.getElementById('location').textContent = `城市: ${city}`;
      fetchWeather(lat, lon, city);
    } else {
      throw new Error('IP定位数据异常');
    }
  }).catch(err => {
    console.warn('IP定位失败，尝试降级到北京...', err);
    document.getElementById('location').textContent = 'IP定位失败，已切换为北京天气';
    document.getElementById('city-error').textContent = 'IP定位失败';
    document.getElementById('city-error').style.display = 'block';
    // 降级到北京
    getLocationByCity('北京');
  });
}

/* ====== 新增：时间更新函数 ====== */
function updateDateTime() {
    const now = new Date();
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    const dateTimeStr = `${year}年${month}月${day}日 ${hours}:${minutes}:${seconds}`;
    document.getElementById('datetime').textContent = dateTimeStr;
}

/* ====== 事件绑定 ====== */
document.getElementById('search-city').addEventListener('click', ()=>{
  getLocationByCity(document.getElementById('city-input').value);
});
document.getElementById('city-input').addEventListener('keypress',(e)=>{
  if(e.key === 'Enter') getLocationByCity(document.getElementById('city-input').value);
});

/* 启动：尝试获取定位 -> 否则降级北京 */
// 直接调用新的IP定位函数
getLocationByIp();
// 启动时间更新
updateDateTime();
setInterval(updateDateTime, 1000);
</script>
</body>
</html>
