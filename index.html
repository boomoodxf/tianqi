<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>åŠ¨æ€å¤©æ°”</title>
<style>
  html,body{margin:0;padding:0;height:100%;font-family:"Segoe UI",sans-serif;color:#333;overflow-x:hidden}
  body{position:relative;transition:background 0.6s ease}
  canvas{position:fixed;top:0;left:0;z-index:-1}
  .container{max-width:900px;margin:auto;padding:20px}
  .card{background:rgba(255,255,255,0.85);border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 8px 20px rgba(0,0,0,0.1)}
  .title{font-size:1.5em;font-weight:bold;margin-bottom:10px}
  .weather-main{display:flex;justify-content:space-between;align-items:center}
  .weather-temp{font-size:2.5em;font-weight:bold}
  .forecast{display:flex;overflow-x:auto;gap:10px}
  .forecast-item{flex:0 0 auto;background:rgba(255,255,255,0.9);border-radius:10px;padding:10px;text-align:center;width:100px;box-shadow:0 4px 10px rgba(0,0,0,0.05)}
  #city-error{color:#d9534f;margin-top:5px;font-size:14px;display:none}
</style>
</head>
<body>
<canvas id="weatherCanvas"></canvas>

<div class="container">
  <div class="card" id="location-card">
    <div class="title">å½“å‰ä½ç½®</div>
    <div id="location-display" style="display: flex; justify-content: space-between; align-items: center;">
      <div id="location">æ­£åœ¨æ ¹æ®IPè·å–å®šä½...</div>
      <div id="datetime" style="font-size:0.9em;color:#666;"></div>
    </div>
    <div style="margin-top:15px;">
      <div style="display:flex;gap:10px;align-items:center;">
        <input id="city-input" type="text" placeholder="è¯·è¾“å…¥åŸå¸‚åç§°" style="padding:8px;flex:1;border:1px solid #ddd;border-radius:5px">
        <button id="search-city" style="padding:8px 15px;background:#4facfe;color:#fff;border:none;border-radius:5px">æŸ¥è¯¢</button>
      </div>
      <p id="city-error">é”™è¯¯ä¿¡æ¯</p>
    </div>
  </div>

  <div class="card">
    <div class="title">å®æ—¶å¤©æ°”</div>
    <div class="weather-main">
      <div>
        <div id="temp" class="weather-temp">--Â°C</div>
        <div id="desc">--</div>
      </div>
      <div id="icon" style="font-size:48px">â˜€ï¸</div>
    </div>
  </div>

  <div class="card">
    <div class="title">æœªæ¥48å°æ—¶</div>
    <div id="hourly" class="forecast"></div>
  </div>

  <div class="card">
    <div class="title">æœªæ¥3å¤©</div>
    <div id="daily" class="forecast"></div>
  </div>
</div>

<script>
/* ====== ä¿ç•™ä½ åŸæ¥çš„ API keys ====== */
const API_KEY = "0nRahTS8MYHrujeP"; // å½©äº‘å¤©æ°”ï¼ˆJSONPï¼‰
const GAODE_API_KEY = "bd5388dfef81ab0f12b81ff9d179b61b"; // é«˜å¾·åœ°å›¾

/* ====== ç”»å¸ƒä¸çŠ¶æ€ ====== */
const canvas = document.getElementById('weatherCanvas');
const ctx = canvas.getContext('2d');
let particles = [];
let _lightningInterval = null;
let _lightningFlash = 0;
let _lastWeatherScriptId = null;
let _currentWeatherCity = ''; // å½“å‰è¯·æ±‚çš„åŸå¸‚åï¼ˆç”¨äºç‰¹æ•ˆåˆ¤æ–­ï¼‰
resizeCanvas();
window.addEventListener('resize', resizeCanvas);
function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

/* ====== æ¸…ç†/ç‰¹æ•ˆå·¥å‚ ====== */
function clearEffects(){
  particles = [];
  if (_lightningInterval) { clearInterval(_lightningInterval); _lightningInterval = null; }
  _lightningFlash = 0;
}
function createRain(count=160){
  for(let i=0;i<count;i++){
    particles.push({type:'rain', x:Math.random()*canvas.width, y:Math.random()*canvas.height, len:Math.random()*20+12, speed:Math.random()*4+6, alpha: Math.random()*0.5+0.35});
  }
}
function createSnow(count=120){
  for(let i=0;i<count;i++){
    particles.push({type:'snow', x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*3+1, speed:Math.random()*0.6+0.3});
  }
}
function createSnowGlow(count=28){
  for(let i=0;i<count;i++){
    particles.push({type:'snowglow', x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*4+3, speed:Math.random()*0.4+0.1});
  }
}
function createFloatingLights(count=60){
  for(let i=0;i<count;i++){
    particles.push({type:'light', x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*1.8+0.8, speed:Math.random()*0.4+0.1, alpha: Math.random()*0.6+0.3});
  }
}
function createClouds(count=8){
  for(let i=0;i<count;i++){
    particles.push({type:'cloud', x:Math.random()*canvas.width, y:Math.random()*canvas.height*0.6, r:Math.random()*80+60, speed:(Math.random()*0.3+0.03), alpha: Math.random()*0.25+0.12});
  }
}
function createLightning(){
  if (_lightningInterval) clearInterval(_lightningInterval);
  // éšæœºé—´éš”è§¦å‘çŸ­æ—¶é—ªå…‰ï¼ˆä½¿ç”¨ _lightningFlash æ§åˆ¶å¸§æ•°ï¼‰
  _lightningInterval = setInterval(()=>{
    // 30% æ¦‚ç‡è§¦å‘é—ªç”µï¼Œè¿™æ ·ä¸ä¼šå¤ªé¢‘ç¹
    if (Math.random() < 0.35) _lightningFlash = Math.floor(2 + Math.random()*5);
  }, 2200 + Math.random()*3000);
}

/* ====== æ ¹æ® skycon ä¸åŸå¸‚è®¾ç½®æ•ˆæœ ====== */
function setBackgroundEffect(skycon = "", cityName = ""){
  clearEffects();
  skycon = (skycon || "").toUpperCase();
  cityName = cityName || "";
  if(skycon.includes("RAIN")){
    createRain(160);
    createClouds(6);
    createLightning();
  } else if(skycon.includes("SNOW")){
    createSnow(120);
    createSnowGlow(28);
    createClouds(5);
  } else if(skycon.includes("CLEAR")){
    createFloatingLights(60);
    createClouds(4);
  } else if(skycon.includes("CLOUD")){
    createClouds(10);
  } else {
    createClouds(6);
  }
  // åŒ—äº¬å¢å¼ºæ•ˆæœï¼ˆå¯æŒ‰éœ€è°ƒæ•´ï¼‰
  if(/åŒ—äº¬/.test(cityName)){
    if(skycon.includes("CLEAR")) createFloatingLights(40);
    if(skycon.includes("RAIN")) createClouds(10);
  }
}

/* ====== èƒŒæ™¯é¢œè‰² ====== */
function setBackgroundColor(skycon = ""){
  const map = {
    "CLEAR_DAY":"linear-gradient(to bottom,#4facfe,#00f2fe)",
    "CLEAR_NIGHT":"linear-gradient(to bottom,#0f2027,#203a43)",
    "PARTLY_CLOUDY_DAY":"linear-gradient(to bottom,#a1c4fd,#c2e9fb)",
    "PARTLY_CLOUDY_NIGHT":"linear-gradient(to bottom,#2c3e50,#4ca1af)",
    "CLOUDY":"linear-gradient(to bottom,#cfd9df,#e2ebf0)",
    "RAIN":"linear-gradient(to bottom,#00c6fb,#005bea)",
    "SNOW":"linear-gradient(to bottom,#e0f7ff,#f7fbff)"
  };
  document.body.style.background = map[skycon] || "linear-gradient(to bottom,#a0cfff,#ffffff)";
}

/* ====== æ¸²æŸ“å¾ªç¯ ====== */
function animate(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // é—ªç”µè¦†ç›–å±‚
  if(_lightningFlash > 0){
    ctx.fillStyle = `rgba(255,255,255,${0.12 + Math.random()*0.3})`;
    ctx.fillRect(0,0,canvas.width,canvas.height);
    _lightningFlash--;
  }

  for(let p of particles){
    if(p.type === 'rain'){
      ctx.beginPath();
      ctx.strokeStyle = `rgba(174,194,224,${p.alpha})`;
      ctx.lineWidth = 1;
      ctx.moveTo(p.x, p.y);
      ctx.lineTo(p.x, p.y + p.len);
      ctx.stroke();
      p.y += p.speed;
      p.x += Math.sin(p.y/20)*0.6;
      if(p.y > canvas.height + p.len) { p.y = -p.len; p.x = Math.random()*canvas.width; }
    } else if(p.type === 'snow'){
      ctx.beginPath();
      ctx.fillStyle = "rgba(255,255,255,0.9)";
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();
      p.y += p.speed;
      p.x += Math.sin(p.y/30)*0.3;
      if(p.y > canvas.height + p.r) { p.y = -p.r; p.x = Math.random()*canvas.width; }
    } else if(p.type === 'snowglow'){
      ctx.save();
      ctx.beginPath();
      ctx.shadowColor = "white";
      ctx.shadowBlur = 12;
      ctx.fillStyle = "rgba(255,255,255,0.95)";
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
      ctx.restore();
      p.y += p.speed;
      if(p.y > canvas.height + p.r) { p.y = -p.r; p.x = Math.random()*canvas.width; }
    } else if(p.type === 'light'){
      ctx.beginPath();
      ctx.fillStyle = `rgba(255,255,200,${p.alpha})`;
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
      p.y += p.speed;
      p.x += Math.sin(p.y/60)*0.2;
      if(p.y > canvas.height + p.r) { p.y = -p.r; p.x = Math.random()*canvas.width; }
    } else if(p.type === 'cloud'){
      ctx.save();
      ctx.globalAlpha = p.alpha;
      ctx.beginPath();
      ctx.ellipse(p.x, p.y, p.r*1.6, p.r, 0, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255,255,255,0.85)';
      ctx.fill();
      ctx.restore();
      p.x += p.speed;
      if(p.x - p.r*2 > canvas.width) p.x = -p.r*2;
    }
  }

  requestAnimationFrame(animate);
}
animate();

/* ====== JSONP: è¯·æ±‚ä¸å›è°ƒç®¡ç† ====== */
function fetchWeather(lat, lon, cityName = ""){
  // æ¸…ç†ä¸Šä¸€æ¬¡ jsonp scriptï¼ˆé¿å…å †ç§¯ï¼‰
  if(_lastWeatherScriptId){
    const old = document.getElementById(_lastWeatherScriptId);
    if(old) old.remove();
    _lastWeatherScriptId = null;
  }
  _currentWeatherCity = cityName || '';
  const id = 'caiyun-jsonp-' + Date.now();
  _lastWeatherScriptId = id;
  const script = document.createElement('script');
  script.id = id;
  script.src = `https://api.caiyunapp.com/v2.6/${API_KEY}/${lon},${lat}/weather.jsonp?callback=MYCALLBACK`;
  script.onerror = () => {
    document.getElementById('city-error').textContent = 'å¤©æ°”æ•°æ®åŠ è½½å¤±è´¥';
    document.getElementById('city-error').style.display = 'block';
  };
  document.body.appendChild(script);
}

/* å…¨å±€å›è°ƒï¼ˆå½©äº‘ JSONP ä¼šè°ƒç”¨ MYCALLBACKï¼‰ */
function MYCALLBACK(data){
  // æ¸…ç† jsonp scriptï¼ˆå·²åŠ è½½ï¼‰
  if(_lastWeatherScriptId){
    const s = document.getElementById(_lastWeatherScriptId);
    if(s) s.remove();
    _lastWeatherScriptId = null;
  }
  document.getElementById('city-error').style.display = 'none';

  if(!data || !data.result){
    document.getElementById('city-error').textContent = 'å¤©æ°”æ•°æ®å¼‚å¸¸';
    document.getElementById('city-error').style.display = 'block';
    return;
  }

  const realtime = data.result.realtime || {};
  const hourly = data.result.hourly || {};
  const daily = data.result.daily || {};

  document.getElementById('temp').textContent = (realtime.temperature !== undefined) ? `${realtime.temperature}Â°C` : '--Â°C';
  const skycon = (realtime.skycon || '').toUpperCase();
  document.getElementById('desc').textContent = skyconToChinese(skycon);
  document.getElementById('icon').textContent = skyconEmoji(skycon);

  // èƒŒæ™¯é¢œè‰²ä¸ç‰¹æ•ˆï¼ŒåŸºäºå½“å‰è¯·æ±‚çš„åŸå¸‚åï¼ˆ_currentWeatherCityï¼‰
  setBackgroundColor(skycon);
  setBackgroundEffect(skycon, _currentWeatherCity);

  // å¡«å……å°æ—¶é¢„æŠ¥
  const hourlyDiv = document.getElementById('hourly');
  hourlyDiv.innerHTML = '';
  if(hourly.temperature && hourly.temperature.length){
    const len = Math.min(hourly.temperature.length, (hourly.skycon && hourly.skycon.length) ? hourly.skycon.length : hourly.temperature.length);
    for(let i=0;i<len;i++){
      const tObj = hourly.temperature[i];
      const timeStr = tObj && tObj.datetime ? new Date(tObj.datetime).getHours() + 'æ—¶' : (i + 'h');
      const tVal = tObj && (tObj.value !== undefined) ? `${tObj.value}Â°C` : '--';
      const skyVal = (hourly.skycon && hourly.skycon[i] && hourly.skycon[i].value) ? hourly.skycon[i].value : '';
      const div = document.createElement('div');
      div.className = 'forecast-item';
      div.innerHTML = `<div>${timeStr}</div><div>${skyconEmoji(skyVal)}</div><div>${tVal}</div><div style="font-size:12px">${skyconToChinese(skyVal)}</div>`;
      hourlyDiv.appendChild(div);
    }
  } else {
    hourlyDiv.innerHTML = '<div class="forecast-item">æ— å°æ—¶æ•°æ®</div>';
  }

  // å¡«å……æ—¥é¢„æŠ¥
  const dailyDiv = document.getElementById('daily');
  dailyDiv.innerHTML = '';
  if(daily.temperature && daily.temperature.length){
    // åªæ˜¾ç¤ºå‰ 7 å¤©çš„æ•°æ®
    const len = Math.min(daily.temperature.length, 3);
    for(let i=0;i<len;i++){
      const tObj = daily.temperature[i];
      const dateStr = tObj && tObj.date ? new Date(tObj.date).toLocaleDateString() : ('ç¬¬' + (i+1) + 'å¤©');
      const tMax = tObj && (tObj.max !== undefined) ? tObj.max : '--';
      const tMin = tObj && (tObj.min !== undefined) ? tObj.min : '--';
      const skyVal = (daily.skycon && daily.skycon[i] && daily.skycon[i].value) ? daily.skycon[i].value : '';
      const div = document.createElement('div');
      div.className = 'forecast-item';
      div.innerHTML = `<div>${dateStr}</div><div>${skyconEmoji(skyVal)}</div><div>${tMax} / ${tMin}Â°C</div><div style="font-size:12px">${skyconToChinese(skyVal)}</div>`;
      dailyDiv.appendChild(div);
    }
  } else {
    dailyDiv.innerHTML = '<div class="forecast-item">æ— æ—¥æ•°æ®</div>';
  }
}

/* ====== skycon è¾…åŠ© ====== */
function skyconEmoji(skycon){
  if(!skycon) return 'â€”';
  const map = {'CLEAR_DAY':'â˜€ï¸','CLEAR_NIGHT':'ğŸŒ™','PARTLY_CLOUDY_DAY':'â›…','PARTLY_CLOUDY_NIGHT':'â˜ï¸','CLOUDY':'â˜ï¸','RAIN':'ğŸŒ§ï¸','SNOW':'â„ï¸','HAZE':'ğŸŒ«ï¸','LIGHT_RAIN':'ğŸŒ¦ï¸'};
  return map[skycon] || 'â˜€ï¸';
}
function skyconToChinese(skycon){
  if(!skycon) return 'æœªçŸ¥';
  const map = {'CLEAR_DAY':'æ™´å¤©','CLEAR_NIGHT':'æ™´(å¤œ)','PARTLY_CLOUDY_DAY':'å¤šäº‘','PARTLY_CLOUDY_NIGHT':'å¤šäº‘(å¤œ)','CLOUDY':'é˜´å¤©','RAIN':'é™é›¨','SNOW':'é™é›ª','HAZE':'é›¾éœ¾'};
  return map[skycon] || skycon;
}

/* ====== åŸå¸‚/ç»çº¬äº’è½¬ï¼ˆé«˜å¾·ï¼‰ ====== */
function getLocationByCity(cityName){
  cityName = (cityName || '').trim();
  if(!cityName){
    document.getElementById('city-error').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆåŸå¸‚åç§°';
    document.getElementById('city-error').style.display = 'block';
    return;
  }
  document.getElementById('city-error').style.display = 'none';
  document.getElementById('location').textContent = `æ­£åœ¨è·å– ${cityName} çš„ä½ç½®ä¿¡æ¯...`;
  const url = `https://restapi.amap.com/v3/geocode/geo?key=${GAODE_API_KEY}&address=${encodeURIComponent(cityName)}`;
  fetch(url).then(r=>r.json()).then(data=>{
    if(data && data.status === '1' && data.geocodes && data.geocodes.length>0){
      const loc = data.geocodes[0].location || '';
      const [lon,lat] = loc.split(','); // é«˜å¾·æ˜¯lon,laté¡ºåº
      document.getElementById('location').textContent = `åŸå¸‚: ${cityName}`;
      fetchWeather(lat, lon, cityName);
    } else {
      document.getElementById('city-error').textContent = `æœªæ‰¾åˆ° ${cityName} çš„ä½ç½®ä¿¡æ¯`;
      document.getElementById('city-error').style.display = 'block';
      document.getElementById('location').textContent = 'å®šä½å¤±è´¥';
    }
  }).catch(err=>{
    console.error('é«˜å¾·åœ°ç†ç¼–ç å¤±è´¥', err);
    document.getElementById('city-error').textContent = 'è·å–ä½ç½®ä¿¡æ¯å¤±è´¥';
    document.getElementById('city-error').style.display = 'block';
    document.getElementById('location').textContent = 'å®šä½å¤±è´¥';
  });
}


/* ====== æ ¸å¿ƒæ”¹åŠ¨ï¼šæ–°çš„ IP å®šä½å‡½æ•° ====== */
function getLocationByIp(){
  document.getElementById('location').textContent = 'æ­£åœ¨å–å®šä½...';
  // é‡‡ç”¨ä¸€ä¸ªå…è´¹çš„IPå®šä½æœåŠ¡
  fetch('https://api.ip.sb/geoip').then(r => r.json()).then(data => {
    if(data && data.latitude !== undefined && data.longitude !== undefined){
      const lat = data.latitude;
      const lon = data.longitude;
      const city = data.city || data.region || 'æœªçŸ¥åŸå¸‚';
      document.getElementById('location').textContent = `åŸå¸‚: ${city}`;
      fetchWeather(lat, lon, city);
    } else {
      throw new Error('IPå®šä½æ•°æ®å¼‚å¸¸');
    }
  }).catch(err => {
    console.warn('IPå®šä½å¤±è´¥ï¼Œå°è¯•é™çº§åˆ°åŒ—äº¬...', err);
    document.getElementById('location').textContent = 'IPå®šä½å¤±è´¥ï¼Œå·²åˆ‡æ¢ä¸ºåŒ—äº¬å¤©æ°”';
    document.getElementById('city-error').textContent = 'IPå®šä½å¤±è´¥';
    document.getElementById('city-error').style.display = 'block';
    // é™çº§åˆ°åŒ—äº¬
    getLocationByCity('åŒ—äº¬');
  });
}

/* ====== æ–°å¢ï¼šæ—¶é—´æ›´æ–°å‡½æ•° ====== */
function updateDateTime() {
    const now = new Date();
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    const dateTimeStr = `${year}å¹´${month}æœˆ${day}æ—¥ ${hours}:${minutes}:${seconds}`;
    document.getElementById('datetime').textContent = dateTimeStr;
}

/* ====== äº‹ä»¶ç»‘å®š ====== */
document.getElementById('search-city').addEventListener('click', ()=>{
  getLocationByCity(document.getElementById('city-input').value);
});
document.getElementById('city-input').addEventListener('keypress',(e)=>{
  if(e.key === 'Enter') getLocationByCity(document.getElementById('city-input').value);
});

/* å¯åŠ¨ï¼šå°è¯•è·å–å®šä½ -> å¦åˆ™é™çº§åŒ—äº¬ */
// ç›´æ¥è°ƒç”¨æ–°çš„IPå®šä½å‡½æ•°
getLocationByIp();
// å¯åŠ¨æ—¶é—´æ›´æ–°
updateDateTime();
setInterval(updateDateTime, 1000);
</script>
</body>
</html>
