<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>动态天气</title>
<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow-x: hidden;
        font-family: "Segoe UI", sans-serif;
        color: #333;
    }
    body {
        position: relative;
    }
    canvas {
        position: fixed;
        top: 0;
        left: 0;
        z-index: -1;
    }
    .container {
        max-width: 900px;
        margin: auto;
        padding: 20px;
    }
    .card {
        background: rgba(255, 255, 255, 0.85);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .title {
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 10px;
    }
    .weather-main {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .weather-temp {
        font-size: 2.5em;
        font-weight: bold;
    }
    .forecast {
        display: flex;
        overflow-x: auto;
        gap: 10px;
    }
    .forecast-item {
        flex: 0 0 auto;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        padding: 10px;
        text-align: center;
        width: 100px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
</style>
</head>
<body>
<canvas id="weatherCanvas"></canvas>

<div class="container">
    <div class="card" id="location-card">
        <div class="title">当前位置</div>
        <div id="location">正在获取定位...</div>
        <div style="margin-top: 15px;">
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="city-input" placeholder="请输入城市名称" style="padding: 8px; flex: 1; border: 1px solid #ddd; border-radius: 5px;">
                <button id="search-city" style="padding: 8px 15px; background: #4facfe; color: white; border: none; border-radius: 5px;">查询</button>
            </div>
            <p id="city-error" style="color: red; margin-top: 5px; font-size: 14px; display: none;"></p>
        </div>
    </div>

    <div class="card">
        <div class="title">实时天气</div>
        <div class="weather-main">
            <div>
                <div id="temp" class="weather-temp">--°C</div>
                <div id="desc">--</div>
            </div>
            <div id="icon" style="font-size:48px;">☀️</div>
        </div>
    </div>

    <div class="card">
        <div class="title">未来48小时</div>
        <div class="forecast" id="hourly"></div>
    </div>

    <div class="card">
        <div class="title">未来3天</div>
        <div class="forecast" id="daily"></div>
    </div>
</div>

<script>
const API_KEY = "0nRahTS8MYHrujeP";
// 高德地图地理编码API密钥
const GAODE_API_KEY = "bd5388dfef81ab0f12b81ff9d179b61b";

// 背景动画
let canvas = document.getElementById("weatherCanvas");
let ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let particles = [];

function setBackgroundEffect(skycon) {
    particles = [];
    if (skycon.includes("RAIN")) createRain();
    else if (skycon.includes("SNOW")) createSnow();
    else particles = []; // 晴天无特效
}

function createRain() {
    for (let i = 0; i < 150; i++) {
        particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            len: Math.random() * 20 + 10,
            speed: Math.random() * 4 + 4
        });
    }
}

function createSnow() {
    for (let i = 0; i < 100; i++) {
        particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            r: Math.random() * 4 + 1,
            speed: Math.random() * 1 + 0.5
        });
    }
}

function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "rgba(255,255,255,0.8)";
    particles.forEach(p => {
        if (p.len) { // rain
            ctx.beginPath();
            ctx.strokeStyle = "rgba(174,194,224,0.8)";
            ctx.moveTo(p.x, p.y);
            ctx.lineTo(p.x, p.y + p.len);
            ctx.stroke();
            p.y += p.speed;
            if (p.y > canvas.height) p.y = -p.len;
        } else { // snow
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fill();
            p.y += p.speed;
            if (p.y > canvas.height) p.y = -p.r;
        }
    });
    requestAnimationFrame(animate);
}
animate();

function setBackgroundColor(skycon) {
    const weatherMap = {
        "CLEAR_DAY": "linear-gradient(to bottom, #4facfe, #00f2fe)",
        "CLEAR_NIGHT": "linear-gradient(to bottom, #141E30, #243B55)",
        "PARTLY_CLOUDY_DAY": "linear-gradient(to bottom, #d7d2cc, #304352)",
        "PARTLY_CLOUDY_NIGHT": "linear-gradient(to bottom, #232526, #414345)",
        "CLOUDY": "linear-gradient(to bottom, #757f9a, #d7dde8)",
        "RAIN": "linear-gradient(to bottom, #00c6fb, #005bea)",
        "SNOW": "linear-gradient(to bottom, #e0eafc, #cfdef3)"
    };
    document.body.style.background = weatherMap[skycon] || "linear-gradient(to bottom, #a0cfff, #ffffff)";
}

function fetchWeather(lat, lon) {
    const url = `https://api.caiyunapp.com/v2.6/${API_KEY}/${lon},${lat}/weather.jsonp?callback=MYCALLBACK`;
    const script = document.createElement('script');
    script.src = url;
    document.body.appendChild(script);
}

function MYCALLBACK(data) {
    if (!data || !data.result) return;
    const realtime = data.result.realtime;
    const hourly = data.result.hourly;
    const daily = data.result.daily;

    document.getElementById("temp").textContent = `${realtime.temperature}°C`;
    document.getElementById("desc").textContent = realtime.skycon;
    document.getElementById("icon").textContent = skyconEmoji(realtime.skycon);

    setBackgroundColor(realtime.skycon);
    setBackgroundEffect(realtime.skycon);

    // 未来48小时
    const hourlyDiv = document.getElementById("hourly");
    hourly.temperature.forEach((t, i) => {
        const time = new Date(hourly.temperature[i].datetime).getHours();
        const div = document.createElement("div");
        div.className = "forecast-item";
        div.innerHTML = `<div>${time}时</div><div>${t.value}°C</div>`;
        hourlyDiv.appendChild(div);
    });

    // 未来3天
    const dailyDiv = document.getElementById("daily");
    daily.temperature.forEach((t, i) => {
        const date = new Date(daily.temperature[i].date).toLocaleDateString();
        const div = document.createElement("div");
        div.className = "forecast-item";
        div.innerHTML = `<div>${date}</div><div>${t.max} / ${t.min}°C</div>`;
        dailyDiv.appendChild(div);
    });
}

function skyconEmoji(skycon) {
    const map = {
        "CLEAR_DAY": "☀️",
        "CLEAR_NIGHT": "🌙",
        "PARTLY_CLOUDY_DAY": "⛅",
        "PARTLY_CLOUDY_NIGHT": "☁️",
        "CLOUDY": "☁️",
        "RAIN": "🌧️",
        "SNOW": "❄️"
    };
    return map[skycon] || "☀️";
}

// 根据城市名称获取经纬度
function getLocationByCity(cityName) {
    if (!cityName || cityName.trim() === '') {
        document.getElementById("city-error").textContent = "请输入有效的城市名称";
        document.getElementById("city-error").style.display = "block";
        return;
    }

    document.getElementById("city-error").style.display = "none";
    document.getElementById("location").textContent = `正在获取${cityName}的位置信息...`;

    const url = `https://restapi.amap.com/v3/geocode/geo?key=${GAODE_API_KEY}&address=${encodeURIComponent(cityName)}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.status === '1' && data.geocodes.length > 0) {
                const location = data.geocodes[0].location;
                const [lon, lat] = location.split(',');
                document.getElementById("location").textContent = `城市: ${cityName}, 纬度: ${lat}, 经度: ${lon}`;
                fetchWeather(lat, lon);
            } else {
                document.getElementById("city-error").textContent = `未找到${cityName}的位置信息，请尝试其他城市`;
                document.getElementById("city-error").style.display = "block";
                document.getElementById("location").textContent = "定位失败";
            }
        })
        .catch(error => {
            console.error('地理编码API请求失败:', error);
            document.getElementById("city-error").textContent = "获取位置信息失败，请重试";
            document.getElementById("city-error").style.display = "block";
            document.getElementById("location").textContent = "定位失败";
        });
}

// 初始化城市查询按钮事件
document.getElementById("search-city").addEventListener('click', () => {
    const cityName = document.getElementById("city-input").value;
    getLocationByCity(cityName);
});

// 按下回车键查询城市
document.getElementById("city-input").addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        const cityName = document.getElementById("city-input").value;
        getLocationByCity(cityName);
    }
});

// 获取位置
function getUserLocation() {
    if (!navigator.geolocation) {
        document.getElementById("location").textContent = "您的浏览器不支持地理位置服务，请输入城市名称查询";
        return;
    }

    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude.toFixed(4);
            const lon = pos.coords.longitude.toFixed(4);
            document.getElementById("location").textContent = `当前位置: 纬度: ${lat}, 经度: ${lon}`;
            fetchWeather(lat, lon);
        },
        err => {
            let errorMsg = "定位失败，请输入城市名称查询";
            switch(err.code) {
                case err.PERMISSION_DENIED:
                    errorMsg = "您拒绝了定位请求，请允许位置权限或输入城市名称查询";
                    break;
                case err.POSITION_UNAVAILABLE:
                    errorMsg = "位置信息不可用，请检查设备定位服务或输入城市名称查询";
                    break;
                case err.TIMEOUT:
                    errorMsg = "定位超时，请重试或输入城市名称查询";
                    break;
                case err.UNKNOWN_ERROR:
                    errorMsg = "未知错误导致定位失败，请输入城市名称查询";
                    break;
            }
            document.getElementById("location").textContent = errorMsg;
            // 删除旧的经纬度输入框
            const oldInputContainer = document.getElementById("location-input-container");
            if (oldInputContainer) {
                oldInputContainer.remove();
            }
        },
        {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        }
    );
}

// 初始化调用
getUserLocation();
</script>
</body>
</html>
